Neverlost
=========
A safety tracking app for caretakers to watch over their dependants, while providing the dependants with some form of privacy.

**Contributors**
- [Simon Jinaphant](https://github.com/SimonJinaphant)
- [Clarence Su](https://github.com/Junwei-Su)
- [Rachel Yeo](https://github.com/r197)
- [Aaron So](https://github.com/aaronso)

## Setup: Common Errors

**Gradle Errors**

If Gradle is unable to build due to the following error error:
`Failed to resolve: com.google.firebase:firebase-messaging:10.2.0`

1. In Android Studio, go to Tools -> Android -> SDK Manager
2. Select the standalone SDK Manager from the bottom
3. Install/Update 2 packages (they should be under `Extra`:
    * Google Play Services
    * Google Repository
4. Rebuild your gradle.

#Firebase Cloud Messaging

Firebase Cloud Messaging (FCM) is a cross-platform solution for communicating between clients and servers; it uses a reliable and battery-efficient connection channel to deliver messages.

- Server can send remote notifications/messages to various client phones (downstream messaging), or allow a client phone to send a message back (upstream messaging). 
- Servers can distribute messages to clients in 3 ways: single device, group of devices, or topics.

### Terminologies

- **FCM Connection Server** - Provided already by Google, these servers are take messages from an app server can distributes them to the clients as it sees fit.
- **App server** - A custom server that we must implement for more control over how messages are handled (we could live without one but then we can't do much). Typically this communicates to the client app through the FCM Connection Server.
- **Client Registration Token** - Uniquely identifies a single device; this is obtained by calling the Java code `FirebaseInstanceId.getInstance().getToken()`. This is typically used to send messages to a specific device.
- **Server Key** - Key to access the FCM Connection Server which is responsible for delivering the messages. This can be obtained in the Firebase console and should be kept a secret. We use this to authenticate ourselves when sending POST requests to the FCM connection server in order to deliver messages.

### Firebase Message Types
Firebase primarily sends 2 types of messages (they can also be combined)

- **Notification message**
    - Light-weight 2KB limit message with a pre-defined set of keys. When the client receives a notification typically a standard Android notification is launched.
        ```json
        {
            "to" : "<Client Registration Token OR Topic>",
            "notification" : {
                "body" : "This is from a POST to FIREBASE",
                "title" : "Neverlost Firebase"
            }
        }
        ```
        
- **Data message**
    - Heavier 4KB limit message with custom key-value pairs for you to group your own data into. Note that sending a data message alone will not trigger any notification.
        ```json
        {
            "to" : "<Client Registration Token OR Topic>",
            "data" : {
                "message" : "This is a message POST-ed to Firebase app server!",
                "another-key" : "This is another value"
            }
        }
        ```
- **Combination of the above**
    - When the client taps on the Android notification generated by the notification message they can also access the `data` field.
        ```json
        {
            "to" : "<Client Registration Token OR Topic>",
            "data" : {
                "message" : "This is a message POST-ed to Firebase app server!",
                "another-key" : "This is another value"
            },
            "notification" : {
                "body" : "This is from a POST to FIREBASE",
                "title" : "Neverlost Firebase"
            }
        }
        ```

The table below outlines how messages are handled depending on the app state.

| App state      | Notification	        | Data	                | Combined                         |
|----------------|:--------------------:|:---------------------:|---------------------------------:|
| Foreground     | onMessageReceived()	| onMessageReceived()	| onMessageReceived                |
| Background	 | System tray          | onMessageReceived()	| system tray and extras of intent |

### Priority
FCM has two options for assigning delivery priority of messages.

- **Normal Priority**
    - This is the default for data messages; in this priority no network connection is made on a sleeping device and the delivery may be delayed.
    - Use this for non time-sensitive messages such as notification of new emails or data to sync.
- **High Priority**
    - This is the default for notification messages; in this priority FCM is allowed to wake a sleeping device when possible to transmit.
    - Use this for important messages such as instant messaging, chat, alerts, etc...
    - Note that this can drain your client's battery more compare to low priority mode.

### Lifespan
FCM usually delivers messages immediately after they are sent; however if the receiving device is offline or unavailable FCM might intentionally delay the message by storing it and delivering it later.

- This is to prevent the app from consuming resources and affecting battery life.
- Use the `time_to_live` parameter in HTTP and XMPP request to specify the maximum lifespan of a message in the range of 0 to 2419200 seconds (4 weeks). 
    - By default the lifespan is the maximum value.

###Collapsible vs Non-collapsible

- **Collapsible** messages only show the most recent by replacing the old message that contains the same collapse key. 
    - FCM allows a max of 4 different collapse keys per devices.
    - Use this if only the latest data is important (ie: Sports app which notifies with current game score).
- **Non-collapsible** is the opposite where each message will not be replaced.
    - Use this if every single message is important to the client and needs to be delivered (ie: Instant messaging app).

### Sending a message via HTTP POST
Using a program like [Advance REST Client](https://chrome.google.com/webstore/detail/advanced-rest-client/hgmloofddffdnphfgcellkdfbfbjeloo) you can easily send a HTTP request to the app server.

1. Set the URL to `https://fcm.googleapis.com/fcm/send`
2. Set the Request Method to `POST`
3. Include the HTTP headers fields
    ```json
        "accept": "application/json"
        "content-type": "application/json"
        "authorization": "key=<FIREBASE APP SERVER KEYâ€¦ASK SIMON>
    ```

4. In the payload you can do the following to send a combined message:
    ```json
    {
        "to" : "<Client Registration Token OR Topic>",
        "data" : {
            "message" : "This is a message POST-ed to Firebase app server!",
            "another-key" : "This is another value"
        },
        "notification" : {
            "body" : "This is from a POST to FIREBASE",
            "title" : "Neverlost Firebase"
        }
    }
    ```
    - If you neglect to put the `notification` field, or the correct pre-defined keys for the notification field then the end users will only get a data message in `onMessageRecieved()` (regardless if its in the background or foreground) without being notified by an Android notification.
 